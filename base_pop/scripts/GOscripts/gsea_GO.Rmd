---
title: "Gene set analysis"
author: "Enoch Ng'oma"
date: "12/20/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DESeq2)
library(tidyverse)
library(gage)
library(pathview)
library(AnnotationDbi)

# Get Dmel gene annotation database
library(org.Dm.eg.db)


#library(help="gage")
#library(EGSEA)
#library(limma)
```

# Set up pathways etc

```{r}
columns(org.Dm.eg.db)

# Generate up-to-date KEGG pathway gene sets 
kegg_sets <- kegg.gsets(species = "dme", id.type = "entrez", check.new=FALSE)

# check that expr data and gene sets both use entrez
lapply(kegg_sets[1:3],head)
head(kegg_sets[[1]])

kegg_sets.dm = kegg_sets$kg.sets[kegg_sets$sigmet.idx]
head(kegg_sets.dm, 3)

#kegg.sets.dm = id.map.fb[kegg.sets$sigmet.idx]

# Generate up-to-date GO (Gene Ontology) gene sets
go_sets <- go.gsets(species = "Fly", 
                    pkg.name="org.Dm.eg.db", 
                    id.type = "eg", 
                    keep.evidence=FALSE)

# Do GO on BP only (i.e. see ...$go.subs)
gobpsets = go_sets$go.sets[go_sets$go.subs$BP]
```

# Get Expression Data
# DESeq2-GAGE workflow
# need libraries: gage, pathview and org.Dm.eg.db
# Used this tutorial together with all 3 vignettes: http://www.gettinggeneticsdone.com/2015/12/tutorial-rna-seq-differential.html


```{r}

load(file="../../processed/DESEQ/all_fc_dat.rda")

# Add annotation maps to results object

# gene symbol
all.fc.dat$symbol = mapIds(org.Dm.eg.db,
                     keys=row.names(all.fc.dat), 
                     column="SYMBOL",
                     keytype="FLYBASE",
                     multiVals="first")

# entrez id
all.fc.dat$entrez = mapIds(org.Dm.eg.db,
                     keys=row.names(all.fc.dat), 
                     column="ENTREZID",
                     keytype="FLYBASE",
                     multiVals="first")

# full gene name
all.fc.dat$name =   mapIds(org.Dm.eg.db,
                     keys=row.names(all.fc.dat), 
                     column="GENENAME",
                     keytype="FLYBASE",
                     multiVals="first")

head(all.fc.dat, 10)
head(all.fc.dat$symbol)


```

# Pathway anaylsis with GAGE
# Aim: enriched pathways

```{r}

cc.sets <- c("FC_DR_B","FC_DR_O","FC_DR_H",
             "FC_HS_B","FC_HS_O","FC_HS_H")

#"FC_DRHS_B","FC_DRHS_O","FC_DRHS_H"

# gage() needs vector of fold changes named with Entrez gene IDs
foldchanges = all.fc.dat$FC_DR_B

names(foldchanges) = all.fc.dat$entrez
head(foldchanges)

# Get the results
keggres = gage(foldchanges, gsets=kegg_sets.dm, same.dir=TRUE)

# Look at both up (greater), down (less), and statatistics.
lapply(keggres, head)

# Get top 5 upregulated pathways
keggrespathways = data.frame(id=rownames(keggres$greater), keggres$greater) %>% 
  tbl_df() %>% 
  filter(row_number()<=5) %>% 
  .$id %>% 
  as.character()
keggrespathways

# Get the IDs (using substr())
keggresids = substr(keggrespathways, start=1, stop=8)
keggresids

# Make pathway plots with pathview()
# Define plotting function to loop through all 5 pathways
plot_pathway = function(pid) pathview(gene.data=foldchanges, pathway.id=pid, species="dme", new.signature=FALSE)

# Plot multiple pathways (plots saved to disk and returns a throwaway list object)
tmp = sapply(keggresids, function(pid) pathview(gene.data=foldchanges, pathway.id=pid, species="dme"))
```

# Construct map between FlyBase ID and Entrez Gene ID
# See "Gene set and data preparation", for ID conversion

```{r}
#id.map.fb <- id2eg(ids = lrt.treatAll$symbol, 
#                   category = "SYMBOL", org = "Dm")

# Map data onto Entrez Gene IDs 
# note different sum.method can be used
#entrez.data <- mol.sum(mol.data = lrt.treatAll$symbol, 
#                       id.map = id.map.fb,
#                       sum.method = "mean")
#lapply(entrez.data[1:3],head)
```

# Gene Ontology (GO)

```{r}

gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)
lapply(gobpres, head)

# Get top 5 upregulated pathways
gobpterms = data.frame(id=rownames(gobpres$greater), gobpres$greater) %>% 
  tbl_df() %>% 
  filter(row_number()<=10) %>% 
  .$id %>% 
  as.character()
gobpterms

# Get the IDs (using substr())
gobpids = substr(gobpterms, start=1, stop=10)
gobpids
```



```{r}
# Get pre-built gene sets for Dmel from http://www.go2msig.org/cgi-bin/prebuilt.cgi
#gsets=readList("../../processed/DESEQ/GO/Drosophila_melanogaster_GSEA_GO_sets_all_symbols_highquality_April_2015.gmt")
#gsets[1:3]

#gsets=readList("../../processed/DESEQ/GO/GeneSets_Dmel.gmt")
#gsets[1:3]

# Convert gsets gene symbols to Entrez IDs
#data(egSymb)
#gsets.sym <- lapply(gsets, sym2eg)
#gsets.sym[1:3] # few associations - see Powell (2014)
```