---
title: "Controlled Vocabularies"
author: "Enoch Ng'oma"
date: "10/18/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data: Effect of treatment

```{r}
# Fbgn annotation file "Genes:fbgn_annotation_ID_fb_2018_04.tsv"

FbAnnotIds <- read.csv("../../processed/DESEQ/fbgn_annotation_ID_fb_2018_04.csv",
                 stringsAsFactors = FALSE)

anotFbgn <- subset(FbAnnotIds, FbAnnotIds$organism_abbreviation=="Dmel")
anotFbgn <- select(anotFbgn, primary_FBgn, annotation_ID)
names(anotFbgn)[1]<-"Gene"
#anotFbgn$FBgn_ID <- toupper(anotFbgn$FBgn_ID)

# Search and merge sigDEGs_int with filtered anotation file
sigInt <- right_join(anotFbgn, sigInt, by="FBgn_ID")

sigLrtTrt <- read.csv("../../processed/DESEQ/DEGs_lrt.treatment_0.05.csv")
names(sigLrtTrt)[1]<-"FBgn_ID"
names(sigLrtTrt)[3] <- "logFC"
names(sigLrtTrt)[7] <- "adj.P.Val" 
sigLrtTrt <- right_join(anotFbgn, sigLrtTrt, by="FBgn_ID")


# export files for GO in DAVID
dfile <- select(sigInt, FBgn_ID)
names(dfile) <- NULL
efile <- select(sigLrtTrt, FBgn_ID)
names(efile) <- NULL

write.csv(dfile, "../../processed/DESEQ/int_forDAVID.csv", row.names = FALSE)
write.csv(efile, "../../processed/DESEQ/CHS_forDAVID.csv", row.names = FALSE)

# Dataframe of DAVID Functional Annotation Chart (246 x 13)
func_anotChart_lrtTrt <- read.table("../../processed/DESEQ/Funct_Anot_Chart_lrtTrt.txt", 
                                 stringsAsFactors = FALSE, header = TRUE,sep = "\t")
```

# Prep Functional Annotation Chart Treatment Dataframe

```{r}
# sort by Category
anot.trt <- func_anotChart_lrtTrt[order(func_anotChart_lrtTrt$Category), ]

# retain GO terms only
anot.trt <- anot.trt[grep('GOTERM_', anot.trt$Category),]

# remove excess chars from rownames
anot.trt <- anot.trt %>%
  mutate(Category = str_split(Category, "_", simplify = TRUE)[,2])

# split Term column
anot.trt <- separate(anot.trt, col = Term, into = c("FBgn_ID", "Term"), sep = "\\~")

anot.trt <- select(anot.trt, Category, FBgn_ID, Term, Genes, Benjamini)
names(anot.trt)[5]<-"adj_pval"

```

# Controlled Vocabularies

```{r}

# gene.association.fb; gaf-version: 2.1; Date: 08/06/2018

#gene.assoc <- read.table("../../processed/DESEQ/gene_association.txt",stringsAsFactors = FALSE, header = TRUE,sep = "\t")
gene.assoc <- read.csv("../../processed/DESEQ/gene_association.csv", stringsAsFactors = FALSE)
gene.assoc <- as.data.frame(gene.assoc[-c(1:5), ])
colnames(gene.assoc)[1] <- "Gene"
colnames(gene.assoc)[2] <- "FBgn_ID"

# CV terms
det_life <- read.csv("../../processed/DESEQ/CV_GO_0008340_determ_adult_lifespan.csv", stringsAsFactors = FALSE)
colnames(det_life)[1] <- "Gene"

# DEGs significant for effect of treatment
degs_treat <- read.csv("../../processed/DESEQ/DEGs_lrt.treatment_0.05.csv", stringsAsFactors = FALSE)
#colnames(degs_treat)[1] <- "FBgn_ID"

# DEGs for treatment effect that are included in CV: determination of adult lifespan (32 genes)
xb <- inner_join(degs_treat,gene.assoc, by="Gene")

# Search GO terms for these in the gene_association.fb
xc <- inner_join(det_life, xb, by="Gene")
xc <- xc[order(xc$GO_Category), ]
xd <- subset(xc, xc$GO_Category=="P")
xdu <- unique(xd$Gene)
xe <- inner_join(xb, anotFbgn, by="Gene")

# Search IDs in anot.trt that are in xd
xf <- inner_join(anot.trt, xd, by="FBgn_ID")
xf <- select(xf, -Genes)
```

# Data: tissue x treatment interaction

```{r}
# Dataframe of genes significant in the LRT test
sigInt <- read.csv("../../processed/DESEQ/DEGs_lrt.int_0.05.csv")
names(sigInt)[1]<-"FBgn_ID"
names(sigInt)[3] <- "logFC"
names(sigInt)[7] <- "adj.P.Val" 

```

# Prep Functional Annotation Chart int Dataframe

```{r}
# sort by Category
anot.int <- func_anotChart_int[order(func_anotChart_lrtTrt$Category), ]

# retain GO terms only
anot.trt <- anot.trt[grep('GOTERM_', anot.trt$Category),]

# remove excess chars from rownames
anot.trt <- anot.trt %>%
  mutate(Category = str_split(Category, "_", simplify = TRUE)[,2])

# split Term column
anot.trt <- separate(anot.trt, col = Term, into = c("FBgn_ID", "Term"), sep = "\\~")

# change multiple columns to factor
#names <- c('Category','FBgn_ID','Term','Genes')
#anot.trt[, names] <- lapply(anot.trt[, names], factor)

anot.trt <- select(anot.trt, Category, FBgn_ID, Term, Genes, Benjamini)
names(anot.trt)[5]<-"adj_pval"

