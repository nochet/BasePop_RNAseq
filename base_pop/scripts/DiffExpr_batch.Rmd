---
title: "Control for batch and do differential expression"
author: "Enoch Ng'oma"
date: "5/7/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load R packagees:
library(tidyverse)
library(cowplot)
library(reshape)
#library(ggthemes)
library(sva)
library(pamr)
library(limma)

set.seed(3176133)
```

# Load data

```{r}
# Expression data
#load("../processed/results/ballG_all_results/log_gfpkm_all.Rda")


# convert to matrix
#log_gfpkm_all <- as.matrix(log_gfpkm_all)
```

# svaseq
# svaseq: Moderated log link sva (i.e. log(g + c; c=1)

```{r}
# use untransformed data - svaseq takes care
load("../processed/results/ballG_all_results/nolog_gfpkm_all.Rda")
nolog_gfpkm_all <- as.matrix(gfpkm_all)

# sample descriprions csv
phenDat <- read.csv("../processed/describe_samples_batch.csv", stringsAsFactors = FALSE)
names(phenDat)[5]<-"batch"
```

```{r}
# svaseq
mod1 <- model.matrix(~as.factor(treatment) + 
                              as.factor(tissue) + 
                              as.factor(batch), 
                              data=phenDat)

mod0 <- model.matrix(~as.factor(batch), data=phenDat) 

# calculate number of surrogate variables
numb_sv = num.sv(nolog_gfpkm_all, mod1, method = "be", B = 5)

print(c("Calculated number of significant SVs = ", numb_sv))

svseq <- svaseq(nolog_gfpkm_all, mod1, mod0, n.sv = numb_sv)
```

# Differential expression using DESeq

```{r}
addSVs <- data.frame(row.names=colnames(nolog_gfpkm_all), svseq$sv[,1], 
                     as.factor(phenDat$batch), as.factor(treatment),
                     as.factor(tissue))
colnames(addSVs) <- c("unsupervised_sv1", "batch", "treatment", "tissue")

dds <- DESeqDataSetFromMatrix(countData=nolog_gfpkm_all, colData=addSVs, 
                              design= ~ unsupervised_sv1 + batch + treatment +
                              tissue)
dds <- DESeq(dds)

```

