---
title: "DiffExpr_batchRemove"
author: "Enoch Ng'oma"
date: "5/7/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load R packagees:
library(ballgown)
library(genefilter)
library(tidyverse)
library(devtools)
library(cowplot)
library(reshape)
#library(ggthemes)
library(sva)
library(pamr)
library(limma)

set.seed(3537633)
```

```{r}
# Function to extract batch-corrected expression values from a sva object

# Ref:
# https://support.bioconductor.org/p/87508/
# https://support.bioconductor.org/p/47350/

cleaningY = function(y, mod, svaobj) {
  X = cbind(mod, svaobj$sv)
  Hat = solve(t(X)%*%X)%*%t(X)
  beta = (Hat%*%t(y))
  P = ncol(mod)
  cleany = y-t(as.matrix(X[,-c(1:P)])%*%beta[-c(1:P),]) 
  return(cleany)
}
```

# Differential expression analysis protocol

```{r}
phenDat <- read.csv("../processed/describe_samples_batch.csv", stringsAsFactors = FALSE)

#bg_ballG <- ballgown(dataDir = "../processed/ballG_all", samplePattern = "", pData = phenDat)

# Save .Rda
#save(bg_ballG, file = "../processed/results/ballG_all_results/bg_ballG_all_results.Rda")

load("../processed/results/ballG_all_results/bg_ballG_all_results.Rda")

# Dispplay a decsription
bg_ballG

```

# Filter to remove low-abundance genes (i.e. those with variance across samples of <=1)

```{r}
bg_ballG_filt <- subset(bg_ballG, "rowVars(texpr(bg_ballG)) >1", genomesubset=TRUE)

# See counts
bg_ballG_filt

save(bg_ballG_filt, file = "../processed/results/ballG_all_results/bg_ballG_filt.Rda")
```

## Overall expression numbers
# Distribution of gene abundances (FPKM values) across samples (libraries), colored by treatment or tissue and faceted 

```{r}
load(file = "../processed/results/ballG_all_results/bg_ballG_filt.Rda")

tfpkm_bg<-texpr(bg_ballG_filt, meas="FPKM")
tfpkm_bg <-log2(tfpkm_bg+1)
colnames(tfpkm_bg)<-phenDat$id
save(tfpkm_bg, file = "../processed/results/ballG_all_results/tfpkm_bg_ballG_filt.Rda")


tbg<- as.data.frame(tfpkm_bg) %>% gather(id, fpkm)
tbg$treatment <- rep(c("C","DR","HS"), each=18*nrow(tfpkm_bg))
tbg$tissue <- rep(c("B","H","O"),each=nrow(tfpkm_bg),6)
tbg$replicate <- rep(c(1,2,3,4,5,6),each=nrow(tfpkm_bg)*3)
tbg$prep <- paste(tbg$treatment,tbg$replicate,sep="_")
tbg$trep <- paste(tbg$tissue,tbg$replicate,sep="_")

b1 <- ggplot(tbg, aes(x=as.factor(prep), y=fpkm,color=treatment)) +
  geom_boxplot(alpha=0.9) +
          theme(axis.title.y = element_text(size = 24),
                axis.title.x=element_blank(),
                axis.text.x  = element_text(angle=90, vjust=0.5),
                text = element_text(size = 20))+
                
  scale_color_manual(values=c("#CC6666", "#9999CC", "#66CC99")) +
  ylab(expression("log"[2]*"(FPKM + 1)")) +
  xlab("Samples")+
  facet_grid(tissue~.)
b1 + theme(legend.position="none")
  
ggsave(filename = "../plots/Expression_by_sample1.pdf",width = 5,height=5)

b2 <- ggplot(tbg, aes(x=as.factor(trep), y=fpkm,color=tissue)) +
  geom_boxplot(alpha=0.9) +
          theme(axis.title.y = element_text(size = 24),
                axis.title.x=element_blank(),
                axis.text.x  = element_text(angle=90, vjust=0.5),
                text = element_text(size = 20)) +
  scale_color_manual(values=c("#CC6666", "#9999CC", "#66CC99")) +
  ylab(expression("log"[2]*"(FPKM + 1)")) +
  xlab("Tissue") +
  #scale_fill_discrete(name="Samples")+
  facet_grid(treatment~.)
b2 + theme(legend.position="none")

ggsave(filename = "../plots/Expression_by_sample2.pdf",width = 5,height=5)
```

## PCA for global patterns

```{r}

gfpkm_bg <-gexpr(bg_ballG_filt)
gfpkm_bg <-log2(gfpkm_bg +1)
colnames(gfpkm_bg)<-phenDat$id
save(gfpkm_bg, file = "../processed/results/ballG_all_results/gfpkm_bg_ballG_filt.Rda")


# all samples
X<- t(scale(t(gfpkm_bg),center=TRUE,scale=FALSE))
sv<- svd(t(X))
U<- sv$u
V<- sv$v
D<- sv$d
Z<- t(X)%*%V

# put PC1 and PC2 into a dataframe and add the phenotpe info side by side
pc.dat<- data.frame(phenDat$id, PC1 = Z[,1], PC2 = Z[,2], PC3 = Z[,3],PC4 =Z[,4])
s.id <- strsplit(as.character(pc.dat$phenDat.id), split="-",fixed=TRUE)
pc.dat$Diet <-unlist(lapply(s.id, function(x) x[1]))
pc.dat$Tissue <- unlist(lapply(strsplit(as.character(phenDat$id), 
                                        split="_", fixed=TRUE), function(x) x[2]))

# plot with ggplot2
a <- ggplot(pc.dat, aes(x=PC1, y=PC2, col=Diet, pch=Tissue)) + 
        geom_point(alpha=0.5, size=5) + 
        scale_color_manual(values=c("#CC6666", "#9999CC", "#66CC99")) +
        theme_bw() +
        theme(axis.title = element_text(size = 24)) +
        theme(text = element_text(size = 20)) +
        theme(panel.border = element_blank(), 
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), 
              axis.line.x = element_line(color="black", size = 0.8),
              axis.line.y = element_line(color="black", size = 0.8))
a 

ggsave(filename = "../plots/PCA_overall.pdf",width = 5,height=5)
```

# Control for batch effects

```{r}
# read table prepped from the ballgown `bg_ballG_all_results.Rda` object

log_gfpkm_sva <- read.csv("../processed/results/ballG_all_results/log_gfpkm_all.csv",
                    stringsAsFactors = FALSE,row.names=1)

# sample data 
phenDat <- read.csv("../processed/describe_samples_batch.csv", stringsAsFactors = FALSE)

# Prepare up data for sva
# Only expression variables needed in matrix form - log2-transformed for sva
#log_gfpkm_sva = log_gfpkm_all %>%
  #select(-GeneName)

#rownames(log_gfpkm_sva) <- log_gfpkm_sva[,1]
#log_gfpkm_sva[,1] <- NULL

log_gfpkm_sva <- as.matrix(log_gfpkm_sva)

```

# sva model without known batch

```{r}
# 1. sva
# Create a full model matrix without adjustment variables
  # since treatment has multiple levels, treat it as factor
mod = model.matrix(~as.factor(treatment) + as.factor(tissue), data=phenDat)

# Create null model (i.e. only adj. vars)
  # with no adjustment - just the intercept included
mod0 = model.matrix(~1, data=phenDat)

# Get number of batch variables
#n.sv = num.sv(basep_all, mod, method = "leek")
n.sv = num.sv(log_gfpkm_sva, mod, method = "be", B = 5) # B are iterations
n.sv

# Note: B should be used only when method = "be"

# b) Estimage surrogate variables
svobj = sva(log_gfpkm_sva, mod, mod0, n.sv=n.sv, B = 5)

#svobj$sv
```

# sva model with a known batch

```{r}
mod.sva_adj <- model.matrix(~as.factor(treatment) + 
                              as.factor(tissue) + 
                              as.factor(group), 
                              data=phenDat)

n.sv_adj = num.sv(log_gfpkm_sva, mod.sva_adj, method = "be", B = 5) # B are iterations
#n.sv_adj

svobj.adj = sva(log_gfpkm_sva, mod.sva_adj, mod0, n.sv=n.sv, B = 5)

#svobj.adj$sv
```

# svaseq
# svaseq: Moderated log link sva
# Note: log(g + c; c=1) was performed in the creation of "basep_all"

```{r}
# use untransformed data - svaseq takes care
nolog_gfpkm_svaseq <- read.csv("../processed/results/ballG_all_results/nolog_gfpkm_all.csv",
                    stringsAsFactors = FALSE)

rownames(nolog_gfpkm_svaseq) <- nolog_gfpkm_svaseq[,1]
nolog_gfpkm_svaseq[,1] <- NULL

# Only expression variables needed in matrix form - untransformed for svaseq
#nolog_gfpkm_svaseq = nolog_gfpkm_all %>%
  #select(-GeneName) 
nolog_gfpkm_svaseq <- as.matrix(nolog_gfpkm_svaseq)

n.sv_svaseq = num.sv(nolog_gfpkm_svaseq, mod, method = "be", B = 5) # B are iterations
n.sv_svaseq

# models
svaseqobj <- svaseq(nolog_gfpkm_svaseq, mod, mod0 , n.sv=n.sv_svaseq, controls = NULL,
                          method = c("irw", "two-step","supervised"),  B = 5,
                          ) # compare with vfilter inluded
svaseqobj$sv
plot(svaseqobj$sv, pch=19,col="red")

# NOTE on sva output:
# pprob.gam: A vector of the posterior probabilities each gene is affected by heterogeneity
# pprob.b: A vector of the posterior probabilities each gene is affected by mod n.sv
```

# Model with batch (i.e. 6 groups or replicates)

```{r}
# Set null and alternative models
mod1 = model.matrix(~as.factor(treatment) + as.factor(tissue) + as.factor(group), data=phenDat)
mod0.gr = cbind(mod1[,1]) # i.e. intercept

# Get number of batch variables
n.svb = num.sv(nolog_gfpkm_svaseq, mod1, B = 5) # B are iterations
n.svb

# Estimate significant surrogate variables
svaseqobj.known = svaseq(nolog_gfpkm_svaseq, mod1, mod0.gr, n.sv=n.svb)$sv
svaseqobj.known

plot(svaseqobj.known, pch=19,col="red")
```

# Remove batch effects from sva results

```{r}
# 1) Calculate F-test p-values for DE wrt diet, without adjusting for SVs
pValues_svaseq = f.pvalue(nolog_gfpkm_svaseq, mod, mod0) #note mod used, not mod1
qValues_svaseq = p.adjust(pValues_svaseq, method = "BH") 

# 2) Adjust for surrogates
  # include surrogates in both full and null models, then get p-vals and q-vals
modSv_svaseq = cbind(mod, svaseqobj$sv) 
# sv is matrix whose columns are estimated SVs

mod0Sv_svaseq = cbind(mod0, svaseqobj$sv)

pValuesSv_svaseq = f.pvalue(nolog_gfpkm_svaseq, modSv_svaseq, mod0Sv_svaseq)
qValuesSv_svaseq = p.adjust(pValuesSv_svaseq, method = "BH")

# These are the adjusted P-values and Q-values accounting for surrogate variables.
# BUT, how to get adjusted expression values for downstream analysis?
```

# Extract corrected expression values from svaseq object

```{r}
# a) can use function
svaseq.dat <- cleaningY(nolog_gfpkm_svaseq, mod = mod, svaobj = svaseqobj)

# compare plots
plot(nolog_gfpkm_svaseq[,c("C.1_H","C.2_H")])  # before sva
plot(svaseq.dat[,c("C.1_H","C.2_H")]) # after sva

# b) can use sva & limma
#nolog_gfpkm_svaseq <- svaseq(nolog_gfpkm_svaseq, mod, mod0 , n.sv_svaseq)
#Covar <- as.factor(cbind(nolog_gfpkm_svaseq$sv))
#nolog_gfpkm_svaseq2 <- removeBatchEffect(nolog_gfpkm_svaseq, covariates = Covar)
#plot(nolog_gfpkm_svaseq2)
```

# Expression pattern for batch-controlled data

#   svaseq.dat = expr values using f(x); 
#   svaseq_basep_all2 = expr values using limma

```{r}
#tfpkm_bg <-log2(svaseq.dat+1)
colnames(svaseq.dat) <- phenDat$id
tbg<- as.data.frame(svaseq.dat) %>% gather(id, fpkm)
tbg$treatment <- rep(c("C","DR","HS"), each=18*nrow(svaseq.dat))
tbg$tissue <- rep(c("B","H","O"),each=nrow(svaseq.dat),6)
tbg$replicate <- rep(c(1,2,3,4,5,6),each=nrow(svaseq.dat)*3)
tbg$prep <- paste(tbg$treatment,tbg$replicate,sep="_")
tbg$trep <- paste(tbg$tissue,tbg$replicate,sep="_")

b1 <- ggplot(tbg, aes(x=as.factor(prep), y=fpkm,color=treatment)) +
  geom_boxplot(alpha=0.9) +
          theme(axis.title.y = element_text(size = 24),
                axis.title.x=element_blank(),
                axis.text.x  = element_text(angle=90, vjust=0.5),
                text = element_text(size = 20))+
                
  scale_color_manual(values=c("#CC6666", "#9999CC", "#66CC99")) +
  ylab(expression("log"[2]*"(FPKM + 1)")) +
  xlab("Samples")+
  facet_grid(tissue~.)
b1 + theme(legend.position="none")
  
#ggsave(filename = "../plots/Expression_by_sample_batchControlled.pdf",width = 5,height=5)

b2 <- ggplot(tbg, aes(x=as.factor(trep), y=fpkm,color=tissue)) +
  geom_boxplot(alpha=0.9) +
          theme(axis.title.y = element_text(size = 24),
                axis.title.x=element_blank(),
                axis.text.x  = element_text(angle=90, vjust=0.5),
                text = element_text(size = 20)) +
  scale_color_manual(values=c("#CC6666", "#9999CC", "#66CC99")) +
  ylab(expression("log"[2]*"(FPKM + 1)")) +
  xlab("Tissue") +
  #scale_fill_discrete(name="Samples")+
  facet_grid(treatment~.)
b2 + theme(legend.position="none")
```

## PCA for global patterns - batch controlled data

```{r}
# all samples
#gfpkm_bg <-gexpr(bg_ballG_filt)
#gfpkm_bg <-log2(gfpkm_bg +1)
#colnames(gfpkm_bg)<-phenDat$id
#save(svaseq.dat, file = "../processed/results/ballG_all_results/svaseq_dat.Rda")

X<- t(scale(t(tbg),center=TRUE,scale=FALSE))
sv<- svd(t(X))
U<- sv$u
V<- sv$v
D<- sv$d
Z<- t(X)%*%V

# put PC1 and PC2 into a dataframe and add the phenotpe info side by side
pc.dat<- data.frame(phenDat$id, PC1 = Z[,1], PC2 = Z[,2], PC3 = Z[,3],PC4 =Z[,4])
s.id <- strsplit(as.character(pc.dat$phenDat.id), split="-",fixed=TRUE)
pc.dat$Diet <-unlist(lapply(s.id, function(x) x[1]))
pc.dat$Tissue <- unlist(lapply(strsplit(as.character(phenDat$id), 
                                        split="_", fixed=TRUE), function(x) x[2]))

# plot with ggplot2
a <- ggplot(pc.dat, aes(x=PC1, y=PC2, col=Diet, pch=Tissue)) + 
        geom_point(alpha=0.5, size=5) + 
        scale_color_manual(values=c("#CC6666", "#9999CC", "#66CC99")) +
        theme_bw() +
        theme(axis.title = element_text(size = 24)) +
        theme(text = element_text(size = 20)) +
        theme(panel.border = element_blank(), 
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), 
              axis.line.x = element_line(color="black", size = 0.8),
              axis.line.y = element_line(color="black", size = 0.8))
a 

ggsave(filename = "../plots/PCA_overall.pdf",width = 5,height=5)
```

