---
title: "Set_up_array_jobs"
author: "Enoch Ng'oma"
date: "4/24/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

## Step 1 Align

```{r}
ll<-character(length=0)

runs<-c(1,2,3)
for(run in runs)
{
  
cat("", file=paste("S01_Align_cmd_run",run,".txt",sep=""))
  
ffs <- list.files(paste("/home/kingeg/Projects/RNA_SEQ_BasePop/Data/run",run,"/",sep=""), pattern="fastq.gz$")

for(ii in 1:length(ffs))
{
st.s <- "hisat2 --dta -q -x indexes/bdgp6_tran/genome_tran -U " 

st.p <- paste("/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/run",run,"/",sep="")

outf <- paste("/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotsams/",strsplit(ffs[ii], ".", fixed=TRUE)[[1]][1],"_run",run,sep="")

cat(paste(st.s, st.p, ffs[ii], " -S ", outf,".sam",sep=""),"\n", file=paste("S01_Align_cmd_run",run,".txt",sep=""),append=TRUE)

ll<- c(ll,paste(strsplit(ffs[ii], ".", fixed=TRUE)[[1]][1],"_run",run,sep=""))

}

}
```

## Samtools sort

```{r}
cat("", file="S02_samtools_all.txt")
for(ii in ll)
{
   cat(paste("samtools sort -@ 8 -o /group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotbams/",ii,".bam ", "/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotsams/", ii,".sam ",sep=""), "\n", file=paste("S02_samtools_all",".txt",sep=""),append=TRUE)

}
```


## Samtools merge: combine transcripts from each run

```{r}
set <- data.frame('code'=unlist(lapply(strsplit(ll, split='_S',fixed=TRUE), function(x) x[1])), 'sample' = ll, stringsAsFactors=FALSE)

un.set <- unique(set$code)

cat("", file="S03_samtools_merge.txt")

for(ii in un.set)
{
  samp.set <- subset(set, code==ii)
   cat(paste("samtools merge -r  /group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotbams/",ii,"_merged.bam ", "/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotbams/", samp.set$sample[1],".bam ","/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotbams/", samp.set$sample[2],".bam ", "/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotbams/", samp.set$sample[3],".bam",sep=""), "\n", file=paste("S03_samtools_merge",".txt",sep=""),append=TRUE)

}
```

# StringTie: Assemble and quantify expressed genes and transcripts

```{r}
# Assemble transcripts for each sample

cat("", file="S04_stringtie_assemble.txt")
cat("", file="assembled_file_list.txt")

indir <- "/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotbams/" 
outdir <- "/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotgtfs/" 

base.cmd <- "stringtie -p 8 -G /group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/genes/dmel-all-r6.18.gtf -o "

for(ff in un.set) 
{
  samp.set <- paste(base.cmd,outdir,ff,"_assembled.gtf ",indir,ff,"_merged.bam",sep="")
  cat(samp.set,"\n", file="S04_stringtie_assemble.txt",append=TRUE)
   
# For stringtie merge 
  cat(paste(outdir,ff,"_assembled.gtf",sep=""), "\n",file="mergelist.txt",append=TRUE)
}
```

# Compare transcripts to reference genome (optional)

```{r}
# gffcompare
# step skipped
```

# StringTie: transcript abundances and table of counts

```{r}
cat("", file="S06_abundances.txt")


indir <- "/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotbams/" 
outdir <- "/group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/ballG/" 


base.cmd <- "stringtie -e -B -p 8 -G /group/kinglab/enoch/MyGithub/BasePop_RNAseq/base_pop/processed/dotgtfs/stringtie_merged.gtf -o "

for(ff in un.set) 
{
  cmd.cut <- paste(base.cmd,outdir,ff,"/",ff,"_ballgown.gtf ", indir,ff,"_merged.bam",sep="")
  cat(cmd.cut,"\n", file="S06_abundances.txt",append=TRUE)
   
}
```

# Create a csv containing sample ids

```{r}
# Make phenotype data file (csv)

# ref. above where we make un.set

idd <- as.data.frame(un.set)
colnames(idd)[colnames(idd)=="un.set"] <- "id"

ids <- idd %>% 
  mutate(id = id,
         treatment = str_split(id, "-", simplify = TRUE)[, 1])%>%
  mutate(replic = str_split(id, "_", simplify = TRUE)[, 1],
         tissue = str_split(id, "_", simplify = TRUE)[, 2]) %>%
  unite(col="treat_tissue", c("treatment", "tissue"), sep="_", remove=FALSE)%>%
  select(-replic)

write.csv(ids, file="describe_samples.csv", row.names=FALSE, quote=FALSE)
```

# Differential expression analysis protocol

```{r}
#R
#load R version R version 3.2.2
#load R packagees:
library(ballgown)
library(genefilter)
library(tidyverse)
library(devtools)

phenDat <- read.csv("describe_samples.csv", stringsAsFactors = FALSE)
```

```{r}
heads_phen <- subset(phenDat, phenDat$tissue=="H")
soma_phen <- subset(phenDat, phenDat$tissue=="B")
ovaries_phen <- subset(phenDat, phenDat$tissue=="O")
bg_ballG_heads <- ballgown(dataDir = "../processed/ballG/heads", samplePattern = "", pData = heads_phen)
bg_ballG_soma <- ballgown(dataDir = "../processed/ballG/soma", samplePattern = "", pData = soma_phen)
bg_ballG_ovaries <- ballgown(dataDir = "../processed/ballG/ovaries", samplePattern = "", pData = ovaries_phen)

# Dispplay a decsription of each tissue
bg_ballG_heads
bg_ballG_soma
bg_ballG_ovaries

# Save .Rda
save(bg_ballG_heads, file = "../processed/ballG/heads/bg_ballG_heads.Rda")
save(bg_ballG_soma, file = "../processed/ballG/soma/bg_ballG_soma.Rda")
save(bg_ballG_ovaries, file = "../processed/ballG/ovaries/bg_ballG_ovaries.Rda")
```


```{r}
load("../processed/ballG/heads/bg_ballG_heads.Rda")
load("../processed/ballG/soma/bg_ballG_soma.Rda")
load("../processed/ballG/ovaries/bg_ballG_ovaries.Rda")
```

# Filter to remove low-abundance genes (i.e. those with variance across samples of <=1)

```{r}
bg_heads_filt <- subset(bg_ballG_heads, "rowVars(texpr(bg_ballG_heads)) >1", genomesubset=TRUE)
bg_soma_filt <- subset(bg_ballG_soma, "rowVars(texpr(bg_ballG_soma)) >1", genomesubset=TRUE)
bg_ovaries_filt <- subset(bg_ballG_ovaries, "rowVars(texpr(bg_ballG_ovaries)) >1", genomesubset=TRUE)

# See counts for each tissue
bg_heads_filt
bg_soma_filt
bg_ovaries_filt
```

# Identify transcripts that show significant differences between groups

```{r}
results_heads_transcripts <- stattest(bg_heads_filt, feature="transcript",
        covariate="treatment", meas="FPKM") 
#which(results_heads_transcripts$qval<=0.05)
#hds.qval <- results_heads_transcripts[which(results_heads_transcripts$qval<=0.05),]

results_soma_transcripts <- stattest(bg_soma_filt, feature="transcript",
        covariate="treatment", meas="FPKM")
#which(results_soma_transcripts$qval<=0.05) 
#soma.qval <- results_soma_transcripts[which(results_soma_transcripts$qval<=0.05),]
  
results_ovaries_transcripts <- stattest(bg_ovaries_filt, feature="transcript",
        covariate="treatment", meas="FPKM")
#which(results_ovaries_transcripts$qval<=0.05) 
#ova.qval <- results_ovaries_transcripts[which(results_ovaries_transcripts$qval<=0.05),]
```

# Identify genes that show statistically significant differences between groups

```{r}
results_heads_genes <- stattest(bg_heads_filt, feature="gene", 
                                covariate="treatment",  meas="FPKM")
which(results_heads_genes$qval<=0.05)

results_soma_genes <- stattest(bg_soma_filt, feature="gene", 
                               covariate="treatment",  meas="FPKM")
which(results_soma_transcripts$qval<=0.05)

results_ovaries_genes <- stattest(bg_ovaries_filt, feature="gene", 
                                  covariate="treatment",  meas="FPKM")
which(results_ovaries_transcripts$qval<=0.05)
```

# Add gene names and gene IDs to the results_transcripts data frame

```{r}
results_heads_transcripts <- data.frame(geneNames=ballgown::transcriptNames(bg_heads_filt), geneIDs=ballgown::geneIDs(bg_heads_filt), results_heads_transcripts)

results_soma_transcripts <- data.frame(geneNames=ballgown::transcriptNames(bg_soma_filt), geneIDs=ballgown::geneIDs(bg_soma_filt), results_soma_transcripts)

results_ovaries_transcripts <- data.frame(geneNames=ballgown::transcriptNames(bg_ovaries_filt), geneIDs=ballgown::geneIDs(bg_ovaries_filt), results_ovaries_transcripts)

full_table.hd<-texpr(bg_heads_filt, 'all')
full_table.sm<-texpr(bg_soma_filt, 'all')
full_table.ov<-texpr(bg_ovaries_filt, 'all')
```

```{r}
# pull gene expression data frame from the ballgown object
#xx.heads <- as.data.frame(gexpr(bg_heads_filt))
#xx.soma <- as.data.frame(gexpr(bg_soma_filt))
#xx.ovaries <- as.data.frame(gexpr(bg_ovaries_filt))
```


# Sort results from smallest P value to largest

```{r}
results_heads_transcripts = arrange(results_heads_transcripts,pval) 
results_heads_genes = arrange(results_heads_genes,pval)

results_soma_transcripts = arrange(results_soma_transcripts,pval) 
results_soma_genes = arrange(results_soma_genes,pval)

results_ovaries_transcripts = arrange(results_ovaries_transcripts,pval) 
results_ovaries_genes = arrange(results_ovaries_genes,pval)

# Transfer transcript names fron stringtie (protocol does not output gene names)

indicies.hds <- match(results_heads_genes$id, texpr(bg_heads_filt, "all")$gene_id)
gene_names_heads <- texpr(bg_heads_filt, "all")$t_name[indicies.hds]
results_heads_genes$tname <- gene_names_heads

indicies.som <- match(results_soma_genes$id, texpr(bg_soma_filt, "all")$gene_id)
gene_names_soma <- texpr(bg_soma_filt, "all")$t_name[indicies.som]
results_soma_genes$tname <- gene_names_soma

indicies.ov <- match(results_ovaries_genes$id, texpr(bg_ovaries_filt, "all")$gene_id)
gene_names_ovaries <- texpr(bg_ovaries_filt, "all")$t_name[indicies.ov]
results_ovaries_genes$tname <- gene_names_ovaries
```

# Write results to csv

```{r}
write.csv(results_heads_transcripts, 
          "../processed/ballG/results/results_bg_heads_transcript.csv", row.names=FALSE)
write.csv(results_heads_genes, 
          "../processed/ballG/results/results_bg_heads_gene.csv", row.names=FALSE)

write.csv(results_soma_transcripts, 
          "../processed/ballG/results/results_bg_soma_transcripts.csv", row.names=FALSE)
write.csv(results_soma_genes, 
          "../processed/ballG/results/results_bg_soma_gene.csv", row.names=FALSE)

write.csv(results_ovaries_transcripts, 
          "../processed/ballG/results/results_bg_ovaries_transcripts.csv", row.names=FALSE)
write.csv(results_ovaries_genes, 
          "../processed/ballG/results/results_bg_ovaries_gene.csv", row.names=FALSE)
```

# Identify transcripts and genes with a q value <0.05

```{r}
sigQval_heads_transcripts <- subset(results_heads_transcripts,results_heads_transcripts$qval<0.05)
sigQval_heads_gene <- subset(results_heads_genes,results_heads_genes$qval<0.05)

sigQval_soma_transcripts <- subset(results_soma_transcripts,results_soma_transcripts$qval<0.05)
sigQval_soma_gene <- subset(results_soma_genes,results_soma_genes$qval<0.05)

sigQval_ovaries_transcripts <- subset(results_ovaries_transcripts,results_ovaries_transcripts$qval<0.05)
sigQval_ovaries_gene <- subset(results_ovaries_genes,results_ovaries_genes$qval<0.05)
```

# Plotting

```{r}
#Set plot settings
tropical= c('darkorange', 'dodgerblue', 'hotpink', 'limegreen', 'yellow')
palette(tropical)
```

# Show the distribution of gene abundances (measured as FPKM values) across samples, colored by treatment

```{r}
fpkm_heads = texpr(bg_ballG_heads,meas="FPKM")
fpkm_heads = log2(fpkm_heads+1) 
boxplot(fpkm_heads,col=as.numeric(phenDat$treatment),las=2,ylab='log2(FPKM+1: heads)')

fpkm_soma = texpr(bg_ballG_soma,meas="FPKM")
fpkm_soma = log2(fpkm_soma+1) 
boxplot(fpkm_soma,col=as.numeric(phenDat$treatment),las=2,ylab='log2(FPKM+1: soma)')

fpkm_ovaries = texpr(bg_ballG_ovaries,meas="FPKM")
fpkm_ovaries = log2(fpkm_ovaries+1) 
boxplot(fpkm_ovaries,col=as.numeric(phenDat$treatment),las=2,ylab='log2(FPKM+1: ovaries)')
```

# Make plots of individual transcripts across samples

```{r}
ballgown::transcriptNames(bg_ballG)[249] ## 12

plot(fpkm[249,] ~ phenDat$treatment, border=c(1,2), main=paste(ballgown::geneNames(bg_ballG)[249],' : ', ballgown::transcriptNames(bg_ballG)[249]),pch=19, xlab="Treatment", ylab='log2(FPKM+1)')
points(fpkm[249,] ~ jitter(as.numeric(phenDat$treatment)), col=as.numeric(phenDat$treatment))
```

# Plot the structure and expression levels in a sample of all transcripts that share the same gene locus

```{r}
plotTranscripts(ballgown::geneIDs(bg_ballG)[128], bg_ballG, main=c('Gene blah-blah in sample DR-4_H'), sample=c('DR-4_H'))
```

# We can also plot the average expression levels for all transcripts of a gene within different groups using the plotMeans function

```{r}
plotMeans('MSTRG.100', bg_ballG_filt,groupvar="treatment",legend=FALSE)
```

# Number of transcripts per gene
```{r}

# Load transcript gene indexes from ballgown objects
t.genes_table.hds <- indexes(bg_ballG_heads)$t2g
t.genes_table.som <- indexes(bg_ballG_soma)$t2g
t.genes_table.ov <- indexes(bg_ballG_ovaries)$t2g

# Plot # of transcripts per gene

# heads
counts <- table(indexes(t.genes_table.hds)[,"g_id"])
h_one <- length(which(counts==1))
h_more <- length(which(counts>1))
h_max <- max(counts)
hist(counts, break=50, col="bisque4", xlab="Transcripts per gene",
main="Distribution of transcript count per gene")
legend_text=c(paste("Genes with one transcript =", h_one), paste("Genes with more than one transcript =", h_more), paste("Max transcripts for single gene = ", h_max))
legend("topright", legend_text, lty=NULL)
```

```{r}

```




