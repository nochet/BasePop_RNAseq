---
title: "WGCNA_ANOVA and GO analysis"
author: "Enoch Ng'oma"
date: "4/8/2019"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(WGCNA)
library(tidyverse)
library(cowplot)
library(AnnotationDbi)
library(org.Dm.eg.db)

```

# Modules for the full dataset

```{r}

# Full dataset

# Load module names
load("../../processed/DESEQ/Coexpression/modules.RData")

# Read in multiple files by wildcard expansion on file paths
getMods <- lapply(Sys.glob(
  "../../processed/DESEQ/Coexpression/Mods/fbgn_names/*.txt",),read.table)

# Rename column
ss <- "FBgn"
for (i in 1:length(getMods)) {
 colnames(getMods[[i]]) <- ss 
}

# Add column for module name to each module
getMods <- mapply(cbind, getMods, "mod"=sort(modNames), 
                  SIMPLIFY=FALSE)
 
# Merge modules in list into one table (12569 + 45 grey)
ll <- bind_rows(getMods)

# Resampled data

# Genes uniquely assigned to module in less than half 50 of 100 datasets
droppedGenes <- read.csv("../../processed/DESEQ/Coexpression/Resamp_droppedGenes.csv")
colnames(droppedGenes)[2] <- "mod"

# Delete droppedGenes in ll
dd <- ll[!(ll$FBgn %in% droppedGenes$FBgn),]
str(dd)
str(ll)

# Move deleted genes to the grey module

lld <- ll[!(ll$FBgn %in% droppedGenes$FBgn),]
droppedGenes$mod <- "grey"
lld <- rbind(lld,droppedGenes)

```

# Compare module contents

```{r}
ll %>% 
  group_by(mod) %>%
  summarise(no_rows = length(mod)) %>%
  as.data.frame()
ll$analysis <- "full"

lld %>%
  group_by(mod) %>%
  summarise(no_rows = length(mod)) %>%
  as.data.frame()
lld$analysis <- "resamp"

# Check one module
stlbl <- rbind(subset(ll, ll$mod=="steelblue"), subset(lld, lld$mod=="steelblue"))

```

# Gene Ontology on WGCNA modules

```{r}
# Modules & module names
load("../../processed/DESEQ/Coexpression/modules.RData")


# Output gene lists
# Fbgn annotation file "Genes:fbgn_annotation_ID_fb_2018_04.tsv"

annot = read.csv("../../processed/DESEQ/Coexpression/FlyAnnotation.csv")
dim(annot)
names(annot)
colnames(annot)[colnames(annot)=="X"] <- "FBgn"

rlogtrt <- read.csv("../../processed/DESEQ/rlogtrt_batchCor.csv")
rownames(rlogtrt) <- rlogtrt[,1]
FBgenes = as.data.frame(rownames(rlogtrt))
colnames(FBgenes)[colnames(FBgenes)=="rownames(rlogtrt)"] <- "FBgn"
FBgenes <- subset(FBgenes, FBgenes$FBgn %in% lld$FBgn)

FBgenes2annot = match(FBgenes$FBgn, annot$FBgn)
allIDs = annot$entrez[FBgenes2annot]


# Module GO term enrichment

# Enrichment table containing the 10 best terms for each module
GOenr <- GOenrichmentAnalysis(moduleColors, allIDs, 
                              organism = "fly", nBestP = 100)
tab <- GOenr$bestPTerms[[4]]$enrichment
names(tab)
write.csv(tab, file = "../../processed/DESEQ/Coexpression/resampMods/GOEnrichTab_Resamp.csv", 
              row.names = FALSE)
### Note message: GOenrichmentAnalysis: loading annotation data...
###  ..of the 12614  Entrez identifiers submitted, 10334 are mapped ###in current GO categories.
###  ..will use 10334 background genes for enrichment calculations.

# View table on screen
keepCols = c(1, 2, 5, 6, 7, 12, 13);
screenTab = tab[, keepCols];

# Round numeric columns to 2 decimal places:
numCols = c(3, 4);
screenTab[, numCols] = signif(apply(screenTab[, numCols], 2, as.numeric), 2)

# Truncate the the term name to at most 40 characters
screenTab[, 7] = substring(screenTab[, 7], 1, 40)

# Shorten the column names:
colnames(screenTab) = c("module", "size", "p-val", "Bonf", "nInTerm", "ont", "termName");
rownames(screenTab) = NULL;

# Set the width of Râ€™s output
options(width=95)

# Enrichment table
screenTab
subset(screenTab, module == "black" & termName == "nucleus")
write.csv(screenTab, file = "../../processed/DESEQ/Coexpression/resampMods/GOEnrichTab_Resamp_simple.csv",
              row.names = FALSE)
```

# Notes for each module

## Black module

```{r}
all.plots[[1]]
aov.mod_black <- aov(eg.genes[,"MEblack"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_black)
black_ph <- TukeyHSD(aov.mod_black)
black_ph
subset(screenTab,screenTab$module=="black")
```

2956 genes
Effect of tissue*** (ovaries differ from rest); treatment**; no interaction. 
Top 10 GO terms: gene expression (RNA metabolism, DNA binding and organellar activiity


## Blue module

```{r}
all.plots[[2]]
aov.mod_blue <- aov(eg.genes[,"MEblue"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_blue)
blue_ph <- TukeyHSD(aov.mod_blue)
blue_ph
subset(screenTab,screenTab$module=="blue")
```

1747 genes
Effect of tissue*** (all tissues differ); treatment*** some interaction* effect
Treatment highly sig for HS-C and HS-DR, insig for DR-C
Tissue highly sig for all pairwise comparisons
Interaction highly sig for 30 diet-tissue comparisons
(The three tissues all different in expression, with slight increase of B&O in HS)
GO: nervous system process, signalling and neuronal activity


## Brown module

```{r}
all.plots[[3]]
aov.mod_brown <- aov(eg.genes[,"MEbrown"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_brown)
brown_ph <- TukeyHSD(aov.mod_brown)
brown_ph
subset(screenTab,screenTab$module=="brown")
```

1084 genes
Effect of tissue*** (heads and overies are together); some interaction effect* 
No treatment effect
Tissue highly sig for H-B and OB, insig for O-H
Interaction sig for 18 diet-tissue contrasts
GO: proteolysis and chitin metabolic process


## Cyan module

```{r}
all.plots[[4]]
aov.mod_cyan <- aov(eg.genes[,"MEcyan"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_cyan)
cyan_ph <- TukeyHSD(aov.mod_cyan)
cyan_ph
subset(screenTab,screenTab$module=="cyan")
```

507 genes
Tissue*** treatment*** interaction***
30 out of 36 interaction contrasts highly significant padj
Treatment highly significant in DR-C and HS-DR comparisons, mildly in HS-C
Tissue highly significant in all 3 comparisons
Interaction highly significant in 30 of 36 comparisons
GO: Redox process, transmembrane ion transport


## Darkgreen module

```{r}
all.plots[[5]]
aov.mod_darkgreen <- aov(eg.genes[,"MEdarkgreen"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_darkgreen)
darkgreen_ph <- TukeyHSD(aov.mod_darkgreen)
subset(screenTab,screenTab$module=="darkgreen")
```

199 genes
Tissue*** treatment*** interaction*
O is high in C and HS but low in DR
Strong treatment effects in HS-DR, mild effect for DR-C, no effect for HS-C 
Strong tissue effect in H-B and O-H, no tissue effect for O-B
Interaction is significant in 17 of 36 diet contrasts
GO: several BPs including signaling

## Darkgrey

```{r}
all.plots[[6]]
aov.mod_darkgrey <- aov(eg.genes[,"MEdarkgrey"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_darkgrey)
darkgrey_ph <- TukeyHSD(aov.mod_darkgrey)
darkgrey_ph
subset(screenTab,screenTab$module=="darkgrey")
```

309 genes
Tissue*** treatment*** interaction***
Treatment highly sig for HS-C and HS-DR, insig for DR-C
Tissue higly sig for 3 comparisons: H-B, O-B, O-H
Interaction sig for 31 of 36 diet-tissue comparisons
(Low in DR high in HS in general)
GO: Ras signaling and binding


## Darkred 

```{r}
all.plots[[7]]
aov.mod_darkred <- aov(eg.genes[,"MEdarkred"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_darkred)
darkred_ph <- TukeyHSD(aov.mod_darkred)
darkred_ph
subset(screenTab,screenTab$module=="darkred")
```

84 genes
Tissue*** treatment*** interaction**
Low in C, high in DR and low in HS
Treatment highly sig for HS-DR and DR-C, insig for HS-C
Tissue higly sig for 2 comparisons: O-B, O-H; mildly for H-B
Interaction sig for 21 of 36 diet-tissue comparisons
(Low in C, high in DR and low in HS)
GO: peptide metabolism, cytosolic ribosome activity

## Darkturquoise 

```{r}
all.plots[[8]]
aov.mod_darkturquoise <- aov(eg.genes[,"MEdarkturquoise"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_darkturquoise)
darkturquoise_ph <- TukeyHSD(aov.mod_darkturquoise)
darkturquoise_ph
subset(screenTab,screenTab$module=="darkturquoise")

```

79 genes
Tissue*** treatment** interaction**
Treatment mildly sig in DR-C and HS-C, insig in HS-DR
Tissue higly sig in all pairwise comparisons
Interaction highly sig in 30 diet-tissue combinations
(Body expression low in C, high in DR & HS)
GO: amino acid transport, proteasome binding


## Greenyellow

```{r}
all.plots[[9]]
aov.mod_greenyellow <- aov(eg.genes[,"MEgreenyellow"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_greenyellow)
greenyellow_ph <- TukeyHSD(aov.mod_greenyellow)
greenyellow_ph
subset(screenTab,screenTab$module=="greenyellow")

```

165 genes
Tissue*** treatment*** interaction***
Treatment highly sig in HS-DR, DR-C, mildly in HS-C
Tissue higly sig in all comparisons
Interaction highly sig in 29 diet-tissue contrasts
(B&O low in C, high in DR & low in HS; H higher in C than other diets)
GO: proteasome catabolic, ubiquitin processes


## Grey module - unassigned genes 

```{r}
all.plots[[10]]
aov.mod_grey <- aov(eg.genes[,"MEgrey"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_grey)
subset(screenTab,screenTab$module=="grey")
```

45 genes
Tissue* treatment*** interaction***
B&H high in C, high intermediate in DR & low in HS; O low in C high in DR & lower in HS
See p-values!!


## Lightcyan module

```{r}
all.plots[[11]]
aov.mod_lightcyan <- aov(eg.genes[,"MElightcyan"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_lightcyan)
lightcyan_ph <- TukeyHSD(aov.mod_lightcyan)
lightcyan_ph
subset(screenTab,screenTab$module=="lightcyan")

```

117 genes
Tissue*** treatment*** interaction**
Treatment highly sig for DR-C and HS-DR, insig for HS-C
Tissue insig for H-B, highly sig for O-B and O-H
(O high in C and HS, low in DR)


## Lightgreen module

```{r}
all.plots[[12]]
aov.mod_lightgreen <- aov(eg.genes[,"MElightgreen"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_lightgreen)
lightgreen_ph <- TukeyHSD(aov.mod_lightgreen)
lightgreen_ph
subset(screenTab,screenTab$module=="lightgreen")
```

107 genes 
Tissue*** treatment*** interaction***
Treatment highly sig DR-C and HS-DR, insig in HS-C
Tissue highly sig in all comparisons
Interaction sig in 26 diet-tissue comparisons
(B&O low in C, high in DR, low in HS; H higher in C)
GO: peptide metabolism, mitochondrial translation


## Lightyellow module

```{r}
all.plots[[13]]
aov.mod_lightyellow <- aov(eg.genes[,"MElightyellow"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_lightyellow)
lightyellow_ph <- TukeyHSD(aov.mod_lightyellow)
lightyellow_ph
subset(screenTab,screenTab$module=="lightyellow")
```

107 genes 
Tissue*** treatment*** interaction***
Treatment highly sig for DR-C and HS-DR, insig for HS-C
Tissue highly sig for H-B and O-H, insig for O-B
Interaction sig for 17 diet-tissue contrasts
(B&O low in C, high in DR, low in HS; H higher in C)
(trend too similar to Lightgreen)
GO: Golgi vesicle transport


## Pink module  

```{r}
all.plots[[14]]
aov.mod_pink <- aov(eg.genes[,"MEpink"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_pink)
pink_ph <- TukeyHSD(aov.mod_pink)
pink_ph
subset(screenTab,screenTab$module=="pink")
```

382 genes
Tissue*** treatment*** interaction**
Treatment highly sig for DR-C and HS-DR, insig for HS-C
Tissue highly highly sig for all comparisons
Interaction highly sig for 24 diet-tissue comparisons
(B&O high in C, low in DR, high in HS; H no pattern)
GO: regulation metabolic process, gene expression, transcription


## Red module  

```{r}
all.plots[[15]]
aov.mod_red <- aov(eg.genes[,"MEred"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_red)
red_ph <- TukeyHSD(aov.mod_red)
red_ph
subset(screenTab,screenTab$module=="red")
```

787 genes
Tissue*** treatment*** interaction***
Treatment highly sig for HS-C and DR-C, mildly for HS-DR
Tissue highly sig for all 3 comparisons
(subtlely increasing in all tissue across C, DR, HS)
GO: olfactory and sensory perception of smell or chemical stimulus


## Royalblue  

```{r}
all.plots[[16]]
aov.mod_royalblue <- aov(eg.genes[,"MEroyalblue"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_royalblue)
royalblue_ph <- TukeyHSD(aov.mod_royalblue)
royalblue_ph
subset(screenTab,screenTab$module=="royalblue")
```

132 genes
Tissue*** treatment*** interaction**
Treatment highly sig for DR-C and HS-DR, insig for HS-C
Tissue highly sig for H-B and O-B, insig for O-H
(B&O high in C, low in DR, high in HS; H low, higher, high)
GO: regulation of metabolic process, regulation of gene expression


## Salmon module

```{r}
all.plots[[17]]
aov.mod_salmon <- aov(eg.genes[,"MEsalmon"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_salmon)
salmon_ph <- TukeyHSD(aov.mod_salmon)
salmon_ph
subset(screenTab,screenTab$module=="salmon")
```

157 genes
Tissue*** treatment*** interaction***
(B high, low, high; H&O low, higher, high)
Treatment highly sig in HS-C and HS-DR, insig in DR-C
Tissue highly sig in all 3 comparisons
Interaction highly sig in 27 diet-tissue comparisons


## Skyblue module

```{r}
all.plots[[18]]
aov.mod_skyblue <- aov(eg.genes[,"MEskyblue"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_skyblue)
skyblue_ph <- TukeyHSD(aov.mod_skyblue)
skyblue_ph
subset(screenTab,screenTab$module=="skyblue")
```

52 genes
Tissue* treatment*** interaction***
Treatment highly sig in DR-C and HS-DR, insig in HS-C
Tissue marginally sig for O-B
Interaction highly sig in 13 diet-tissue comparisons
(B&O low, high, low; H high, low, low)
GO: peptide metabolic process, ribosome


## Steelblue module 

```{r}
all.plots[[19]]
aov.mod_steelblue <- aov(eg.genes[,"MEsteelblue"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_steelblue)
steelblue_ph <- TukeyHSD(aov.mod_steelblue)
steelblue_ph
subset(screenTab,screenTab$module=="steelblue")
```
44 genes
Tissue*** treatment*** interaction*
high, low, high; larger effect in ovaries
Treatment highly sig in DR-C and HS-DR, insig in HS-C
Tissue sig for O-B and O-H only
Interaction highly sig in 8 diet-tissue comparisons
GO: protein localization and binding


## Tan module 

```{r}
all.plots[[20]]
aov.mod_tan <- aov(eg.genes[,"MEtan"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_tan)
tan_ph <- TukeyHSD(aov.mod_tan)
tan_ph
subset(screenTab,screenTab$module=="tan")
```

163 genes
Tissue*** treatment*** interaction***
Treatment highly sig in DR-C and HS-DR, insig in HS-C
Tissue highly sig for all comparisons
Interaction highly sig in 29 diet-tissue comparisons
(O low, high, low; larger effect in ovaries)
GO: pigment biosynthesis


## Turquoise module 

```{r}
all.plots[[21]]
aov.mod_turquoise <- aov(eg.genes[,"MEturquoise"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_turquoise)
turquoise_ph <- TukeyHSD(aov.mod_turquoise)
turquoise_ph
subset(screenTab,screenTab$module=="turquoise")
```

3337 genes
Tissue*** treatment*** interaction*
All tissues low in C and similar for DR and HS
Treatment highly sig in DR-C and HS-C, insig in HS-DR
Tissue highly sig for O-B and O-H comparisons, insig for H-B
Interaction highly sig in 22 diet-tissue comparisons
GO: Redox process, bacterial/defence respnse, iron ion binding


## White module

```{r}
all.plots[[22]]
aov.mod_white <- aov(eg.genes[,"MEwhite"] ~ phenDat.sva$treatment* phenDat.sva$tissue)
summary(aov.mod_white)
white_ph <- TukeyHSD(aov.mod_white)
white_ph
subset(screenTab,screenTab$module=="white")
```
54 genes
Tissue*** treatment*** interaction***
Treatment highly sig in HS-C, mildly in DR-C, insig in HS-DR
Tissue highly sig for H-B and O-B comparisons, insig for O-H
Interaction highly sig in 15 diet-tissue comparisons
(B low in C, high in DR, higher in HS; other tissues no clear trend)
GO: chitin, cuticle development, body morphogenesis


