---
title: "Base Population analysis with DESeq2"
author: "Enoch Ng'oma"
date: "10/21/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DESeq2)
library(dplyr)
library(stringr)
library(ggplot2)
library(RColorBrewer)
```

# Expression count data

```{r}
read.csv(countdata, "../../processed/DESEQ/normExpr_countData.csv", row.names = FALSE)

```

# Nested models

```{r}
# Create a DESeqDataSet from count matrix and labels

dds.01 <- DESeqDataSetFromMatrix(countData = countdata, 
                                   colData = phenDat.sva, 
                                   design = ~ SV1 + batch + tissue + treatment)

dds.02 <- DESeqDataSetFromMatrix(countData = countdata, 
                                   colData = phenDat.sva, 
                                   design = ~ SV1 + batch + tissue*treatment)

# either run DESeq or do these three steps
dds_deseq.01 <- estimateSizeFactors(dds.01)
nc <- counts(dds_deseq.01, normalized=TRUE)
filter <- rowSums(nc >= 10) >= 2
dds_deseq.01 <- dds_deseq.01[filter,]
dds_deseq.01 <- estimateDispersions(dds_deseq.01, fitType = "local")
dds_deseq.01 <- nbinomWaldTest(dds_deseq.01, maxit = 1000, useOptim = TRUE)

dds_deseq.02 <- estimateSizeFactors(dds.02)
nc <- counts(dds_deseq.02, normalized=TRUE)
filter <- rowSums(nc >= 10) >= 2
dds_deseq.02 <- dds_deseq.02[filter,]
dds_deseq.02 <- estimateDispersions(dds_deseq.02, fitType = "local")
dds_deseq.02 <- nbinomWaldTest(dds_deseq.02, maxit = 1000, useOptim = TRUE)
dds_deseq.02 <- dds_deseq.02[which(mcols(dds_deseq.02)$betaConv),]

resultsNames(dds_deseq.02)

# Look at the DESeq object
colData(dds_deseq.01)
colData(dds_deseq.02)

# DEGs significant for effect of tissue 
lrt.tissue <- DESeq(dds.01, test="LRT", reduced=~ SV1 + batch + treatment)
lrt.tissue <- lrt.tissue[which(mcols(lrt.tissue)$fullBetaConv),]
lrt.tissue <- results(lrt.tissue, alpha = 0.05)

# DEGs significant for effect of treatment 
lrt.treatment <- DESeq(dds.01, test="LRT", reduced=~ SV1 + batch + tissue)
lrt.treatment <- lrt.treatment[which(mcols(lrt.treatment)$fullBetaConv),]
lrt.treatment <- results(lrt.treatment, alpha = 0.05)

# DEGs significant for effect of the interaction 
lrt.int <- DESeq(dds.02, test="LRT", reduced=~ SV1 + batch + tissue + treatment)
lrt.int <- lrt.int[which(mcols(lrt.int)$fullBetaConv),]
lrt.int <- results(lrt.int, alpha = 0.05)

# pairwise comparisions (treatment effect assuming interaction)
rr1 <- results(dds_deseq.02, contrast=c('tissue', "H","B"), alpha = 0.05)
rr2 <- results(dds_deseq.02, contrast=c('tissue', "O","B"), alpha = 0.05)
rr3 <- results(dds_deseq.02, contrast=c('tissue', "O","H"), alpha = 0.05)

# Get lists of DEGs
resSig_lrt.int <- subset(lrt.int, padj < 0.05)
summary(resSig_lrt.int)
sum(resSig_lrt.int$padj < 0.05, na.rm = TRUE)
resSig_lrt.int$Gene <- rownames(resSig_lrt.int)
resSig_lrt.int <- resSig_lrt.int[, c(7,1:6)]
(resSig_lrt.int <- resSig_lrt.int[order(resSig_lrt.int$padj), ])

resSig_lrt.tissue <- subset(lrt.tissue, padj < 0.05)
summary(resSig_lrt.tissue)
sum(lrt.tissue$padj < 0.05, na.rm = TRUE)
resSig_lrt.tissue$Gene <- rownames(resSig_lrt.tissue)
resSig_lrt.tissue <- resSig_lrt.tissue[, c(7,1:6)]
resSig_lrt.tissue <- resSig_lrt.tissue[order(resSig_lrt.tissue$padj), ]

resSig_lrt.treatment <- subset(lrt.treatment, padj < 0.05)
summary(resSig_lrt.treatment)
sum(lrt.treatment$padj < 0.05, na.rm = TRUE)
resSig_lrt.treatment$Gene <- rownames(resSig_lrt.treatment)
resSig_lrt.treatment <- resSig_lrt.treatment[, c(7,1:6)]
resSig_lrt.treatment <- resSig_lrt.treatment[order(resSig_lrt.treatment$padj), ]

write.csv(dds_deseq.02, "../../processed/DESEQ/dds_deseq.02.csv", row.names = FALSE)
write.csv(resSig_lrt.int, "../../processed/DESEQ/DEGs_lrt.int_0.05.csv", row.names = FALSE)
write.csv(resSig_lrt.tissue, "../../processed/DESEQ/DEGs_lrt.tissue_0.05.csv", row.names = FALSE)
write.csv(resSig_lrt.treatment, "../../processed/DESEQ/DEGs_lrt.treatment_0.05.csv", row.names = FALSE)


# Gene lists for comparisons - treatment effects
resSig_HB <- subset(rr1, padj < 0.05)
summary(resSig_HB)
sum(resSig_HB$padj < 0.05, na.rm = TRUE)
resSig_HB$Gene <- rownames(resSig_HB)
resSig_HB <- resSig_HB[, c(7,1:6)]
(resSig_HB <- resSig_HB[order(resSig_HB$padj), ])
write.csv(resSig_HB, "../../processed/DESEQ/DEGs_HB_0.05.csv", row.names = FALSE)
mcols(resSig_HB)$description

resSig_OB <- subset(rr2, padj < 0.05)
summary(resSig_OB)
sum(resSig_OB$padj < 0.05, na.rm = TRUE)
resSig_OB$Gene <- rownames(resSig_OB)
resSig_OB <- resSig_OB[, c(7,1:6)]
(resSig_OB <- resSig_OB[order(resSig_OB$padj), ])
write.csv(resSig_OB, "../../processed/DESEQ/DEGs_OB_0.05.csv", row.names = FALSE)

resSig_OH <- subset(rr3, padj < 0.05)
summary(resSig_OH)
sum(resSig_OH$padj < 0.05, na.rm = TRUE)
resSig_OH$Gene <- rownames(resSig_OH)
resSig_OH <- resSig_OH[, c(7,1:6)]
(resSig_OH <- resSig_OH[order(resSig_OH$padj), ])
write.csv(resSig_OH, "../../processed/DESEQ/DEGs_OH_0.05.csv", row.names = FALSE)

# Background list - all gene_ids for GO term enrichment
bList <- as.data.frame(rownames(pl3c))
write.csv(bList, "../../processed/DESEQ/gene_background_list.csv")
```

# Are QTL genes in IIS/TOR (Stanley et al 2017) represented
# Treatment effect in the interaction model

```{r}
iis.qtl <- read.csv("../../processed/DESEQ/DEG_QTL/iis_genelist.csv",
                     stringsAsFactors = FALSE) 

# DEG table, interaction H vs B
HB.int_table <- as.data.frame(resSig_HB)
HBvQTL <- HB.int_table %>%
      filter(Gene %in% iis.qtl$fbgn_id)
HBvQTL$comparison <- rep("HBvQTL",length(HBvQTL))

# DEG table, interaction O vs B
OB.int_table <- as.data.frame(resSig_OB)
OBvQTL <- OB.int_table %>%
      filter(Gene %in% iis.qtl$fbgn_id)  
OBvQTL$comparison <- rep("OBvQTL",length(OBvQTL))

# DEG table, interaction O vs H
OH.int_table <- as.data.frame(resSig_OH)
OHvQTL <- OH.int_table %>%
      filter(Gene %in% iis.qtl$fbgn_id)  
OHvQTL$comparison <- rep("OHvQTL",length(20))

qtl_tissueGenes <- rbind(HBvQTL,OBvQTL,OHvQTL)
write.csv(qtl_tissueGenes, "../../processed/DESEQ/DEG_QTL/DEqtl_tissueGenes.csv")
```

# pairwise comparisions (tissue effect, interaction model)

```{r}
ff1 <- results(dds_deseq.02, contrast=c('treatment', "C","DR"), alpha = 0.05)
ff2 <- results(dds_deseq.02, contrast=c('treatment', "C","HS"), alpha = 0.05)
ff3 <- results(dds_deseq.02, contrast=c('treatment', "DR","HS"), alpha = 0.05)
```

```{r}
resSig_CDR <- subset(ff1, padj < 0.05)
summary(resSig_CDR)
sum(resSig_CDR$padj < 0.05, na.rm = TRUE)
resSig_CDR$Gene <- rownames(resSig_CDR)
resSig_CDR <- resSig_CDR[, c(7,1:6)]
(resSig_CDR <- resSig_CDR[order(resSig_CDR$padj), ])
write.csv(resSig_CDR, "../../processed/DESEQ/DEGs_CDR_0.05.csv", row.names = FALSE)
mcols(resSig_CDR)$description

resSig_CHS <- subset(ff2, padj < 0.05)
summary(resSig_CHS)
sum(resSig_CHS$padj < 0.05, na.rm = TRUE)
resSig_CHS$Gene <- rownames(resSig_CHS)
resSig_CHS <- resSig_CHS[, c(7,1:6)]
(resSig_CHS <- resSig_CHS[order(resSig_CHS$padj), ])
write.csv(resSig_CHS, "../../processed/DESEQ/DEGs_CHS_0.05.csv", row.names = FALSE)
mcols(resSig_CHS)$description

resSig_DRHS <- subset(ff3, padj < 0.05)
summary(resSig_DRHS)
sum(resSig_DRHS$padj < 0.05, na.rm = TRUE)
resSig_DRHS$Gene <- rownames(resSig_DRHS)
resSig_DRHS <- resSig_DRHS[, c(7,1:6)]
(resSig_DRHS <- resSig_DRHS[order(resSig_DRHS$padj), ])
write.csv(resSig_DRHS, "../../processed/DESEQ/DEGs_DRHS_0.05.csv", row.names = FALSE)
mcols(resSig_DRHS)$description
```

# Are QTL genes in IIS/TOR (Stanley et al 2017) represented
# Tissue effect in the interaction model

```{r}
# DEG table, interaction C vs DR
CDR.int_table <- as.data.frame(resSig_CDR)
CDRvQTL <- CDR.int_table %>%
      filter(Gene %in% iis.qtl$fbgn_id)
CDRvQTL$comparison <- rep("CDRvQTL",length(2))

# up and down lists
#up_CDRvQTL <- subset(CDRvQTL, log2FoldChange > 0)
#down_CDRvQTL <- subset(CDRvQTL, log2FoldChange < 0)
#write.csv(up_CDRvQTL, 
          #"../../processed/DESEQ/DEG_QTL/sigDEGs_int_up_CDRvQTL.csv")

# DEG table, interaction C vs HS
CHS.int_table <- as.data.frame(resSig_CHS)
CHSvQTL <- CHS.int_table %>%
      filter(Gene %in% iis.qtl$fbgn_id)  
CHSvQTL$comparison <- rep("CHSvQTL",length(1))

# DEG table, interaction DR vs HS
DRHS.int_table <- as.data.frame(resSig_DRHS)
DRHSvQTL <- DRHS.int_table %>%
      filter(Gene %in% iis.qtl$fbgn_id)
DRHSvQTL$comparison <- rep("DRHSvQTL",length(2))

qtl_dietGenes <- rbind(CDRvQTL,CHSvQTL,DRHSvQTL)
write.csv(qtl_dietGenes, "../../processed/DESEQ/DEG_QTL/DEqtl_dietGenes.csv")

qtl_genes <- rbind(qtl_tissueGenes,qtl_dietGenes)
write.csv(qtl_genes, "../../processed/DESEQ/DEG_QTL/qtl_genes_all.csv")

qtl_genesFB <- read.csv("../../processed/DESEQ/DEG_QTL/qtl_genes_all_FlyBase.csv",
                     stringsAsFactors = FALSE)

colnames(qtl_genesFB)[colnames(qtl_genesFB)=="X.SUBMITTED.ID"] <- "submittedID"
colnames(qtl_genes)[colnames(qtl_genes)=="Gene"] <- "submittedID"
qtl_genesFB <- qtl_genesFB %>%
  select(-GO_BIOLOGICAL_PROCESS,-GO_CELLULAR_COMPONENT,-GO_MOLECULAR_FUNCTION, -NAME)
qtl_data <- cbind(qtl_genes,qtl_genesFB)

qtl_data <- qtl_data %>%
  select(-9,-10) %>%
  rename(Gene = submittedID)
(qtl_data <- qtl_data[order(qtl_data$SYMBOL), ])
write.csv(qtl_data, "../../processed/DESEQ/DEG_QTL/qtl_data.csv")
```



# Contrast C vs DR

```{r}
# Comparisons across treatment levels
resultsNames(dds_deseq)

cdr.dds <- results(dds_deseq, contrast=c("treatment","C","DR"))
mcols(cdr.dds) # mcols = metadata columns, i.e. element-wise metadata
(resOrd_cdrdds <- cdr.dds[order(cdr.dds$padj), ])
write.csv(resOrd_cdrdds, 
          "../../processed/DESEQ/CvDR_DEseqSVA_dds_resOrdered_padj.csv", row.names=TRUE)


# MA plot
maplot <- function (resOrd_cdrdds, thresh=0.05, labelsig=TRUE, textcx=1, ...) {
  with(resOrd_cdrdds, plot(baseMean, log2FoldChange, pch=20, cex=.5, log="x", ...))
  with(subset(resOrd_cdrdds, padj<thresh), points(baseMean, log2FoldChange, col="red", pch=20, cex=1.5))
  if (labelsig) {
    require(calibrate)
    with(subset(resOrd_cdrdds, padj<thresh), textxy(baseMean, log2FoldChange, labs="Gene", cex=textcx, col=2))
  }
}
png("diffexpr-maplot.png", 1500, 1000, pointsize=20)
maplot(resOrd_cdrdds, ylim=c(-2,2), main="MA Plot C vs DR")
dev.off()


# Volcano
par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

cdr <- as.data.frame(resOrd_cdrdds)

#Adjusted P values (FDR Q values)
with(cdr, plot(log2FoldChange, -log10(padj), pch=20, main="Volcano plot", cex=1.0, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))

with(subset(cdr, padj<0.05 & abs(log2FoldChange)>2), points(log2FoldChange, -log10(padj), pch=20, col="red", cex=0.5))

with(subset(cdr, padj<0.05 & abs(log2FoldChange)>2), text(log2FoldChange, -log10(padj), labels=subset(rownames(cdr), cdr$padj<0.05 & abs(cdr$log2FoldChange)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(cdr$pvalue[cdr$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)
```

# Contrast C vs HS

```{r}
hs.dds <- results(dds_deseq, contrast=c("treatment","C","HS"))
(resOrd_hsdds <- hs.dds[order(hs.dds$padj), ])

write.csv(resOrd_hsdds, 
          "../../processed/DESEQ/CvHS_DEseqSVA_dds_resOrdered_padj.csv",
          row.names=TRUE)

# MA plot
maplot <- function (resOrd_hsdds, thresh=0.05, labelsig=TRUE, textcx=1, ...) {
  with(resOrd_hsdds, plot(baseMean, log2FoldChange, pch=20, cex=.5, log="x", ...))
  with(subset(resOrd_hsdds, padj<thresh), points(baseMean, log2FoldChange, col="red", pch=20, cex=1.5))
  if (labelsig) {
    require(calibrate)
    with(subset(resOrd_hsdds, padj<thresh), textxy(baseMean, log2FoldChange, labs="Gene", cex=textcx, col=2))
  }
}
png("diffexpr-maplot.png", 1500, 1000, pointsize=20)
maplot(resOrd_hsdds, ylim=c(-2,2), main="MA Plot C vs HS")
dev.off()

# Volcano
par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

hs <- as.data.frame(resOrd_hsdds)

#Adjusted P values (FDR Q values)
with(hs, plot(log2FoldChange, -log10(padj), pch=20, main="Volcano plot", cex=1.0, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))

with(subset(hs, padj<0.05 & abs(log2FoldChange)>2), points(log2FoldChange, -log10(padj), pch=20, col="red", cex=0.5))

with(subset(hs, padj<0.05 & abs(log2FoldChange)>2), text(log2FoldChange, -log10(padj), labels=subset(rownames(hs), hs$padj<0.05 & abs(hs$log2FoldChange)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(hs$pvalue[hs$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)
```

# Contrast DR vs HS

```{r}
dh.dds <- results(dds_deseq, contrast=c("treatment","DR","HS"))
(resOrd_dhdds <- dh.dds[order(dh.dds$padj), ])

write.csv(resOrd_dhdds, 
          "../../processed/DESEQ/DRvHS_DEseqSVA_dds_resOrdered_padj.csv",
          row.names=TRUE)

# MA plot
maplot <- function (resOrd_dhdds, thresh=0.05, labelsig=TRUE, textcx=1, ...) {
  with(resOrd_dhdds, plot(baseMean, log2FoldChange, pch=20, cex=.5, log="x", ...))
  with(subset(resOrd_dhdds, padj<thresh), points(baseMean, log2FoldChange, col="red", pch=20, cex=1.5))
  if (labelsig) {
    require(calibrate)
    with(subset(resOrd_dhdds, padj<thresh), textxy(baseMean, log2FoldChange, labs="Gene", cex=textcx, col=2))
  }
}
png("diffexpr-maplot.png", 1500, 1000, pointsize=20)
maplot(resOrd_dhdds, ylim=c(-2,2), main="MA Plot DR vs HS")
dev.off()

# Volcano
par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

drhs <- as.data.frame(resOrd_dhdds)

#Adjusted P values (FDR Q values)
with(drhs, plot(log2FoldChange, -log10(padj), pch=20, main="Volcano plot", cex=1.0, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))

with(subset(drhs, padj<0.05 & abs(log2FoldChange)>2), points(log2FoldChange, -log10(padj), pch=20, col="red", cex=0.5))

with(subset(drhs, padj<0.05 & abs(log2FoldChange)>2), text(log2FoldChange, -log10(padj), labels=subset(rownames(drhs), drhs$padj<0.05 & abs(drhs$log2FoldChange)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(drhs$pvalue[drhs$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)
```




# Model with interactions

```{r}
dds.int <- DESeqDataSetFromMatrix(countData = countdata, 
                                  colData = phenDat.sva, 
                                  design = ~ SV1 + batch + tissue + treatment + tissue:treatment)

dds.deInt <- estimateSizeFactors(dds.int)
nc <- counts(dds.deInt, normalized=TRUE)
filter <- rowSums(nc >= 10) >= 2
dds.deInt <- dds.deInt[filter,]
dds.deInt <- estimateDispersions(dds.deInt, fitType = "local")
dds.deInt <- nbinomWaldTest(dds.deInt, maxit = 10000, useOptim = TRUE)

# dealing with autocorrelation: https://support.bioconductor.org/p/65091/
#dds_int <- DESeq(dds.int)

# Remove unconverged rows
dds.deInt <- dds.deInt[which(mcols(dds.deInt)$betaConv),]

# Look at the DESeq object
colData(dds.deInt)

# results for all terms

rr1 <- results(dds.deInt, contrast=c('tissue', "H","B"))
rr2 <- results(dds.deInt, contrast=c('tissue', "O","B"))
rr3 <- results(dds.deInt, contrast=c('tissue', "O","H"))

lrt.int <- DESeq(dds.int, test="LRT", reduced=~ SV1 + batch + tissue + treatment)
lrt.int <- results(lrt.int)


# Access results
res_int <- results(dds.deInt)
(resOrd_int <- res_int[order(res_int$padj), ])

save(dds.deInt, file = "../../processed/DESEQ/DEseq_sva_int.Rda")
load("../../processed/DESEQ/DEseq_sva_int.Rda")
# Basic tallies
summary(res_int)

# How many pvalues are less than 0.1
sum(res_int$padj < 0.1, na.rm = TRUE)

# Try alpha 0.05 (default is 0.1)
res05 <- results(dds.deInt, alpha=0.05) 
summary(res05)

# Boxplot of samples
par(mar=c(8,5,2,2))
boxplot(log10(assays(dds.deInt)[["cooks"]]), range=0, las=2)

# Merge with normalized count data
res.int_table <- merge(as.data.frame(res_int), 
                       as.data.frame(counts(dds.deInt, normalized=TRUE)), 
                       by="row.names", sort=FALSE)
names(res.int_table)[1] <- "Gene"

write.csv(resOrd_int, 
          "../../processed/DESEQ/DEseqSVA_int_resOrdered_padj.csv", row.names=TRUE)
```

# Look at highly DE genes

```{r}
topDE <- as.data.frame(res.int_table)

highDown <- which(topDE$log2FoldChange < -5)
topDE[highDown,]

highUp <- which(topDE$log2FoldChange > 5)
topDE[highUp,]
```

# Contrasts

```{r}
# arguments 'name' and 'contrast' to results() are the same

resultsNames(dds.deInt)

# C vs DR
cdr.int <- results(dds.deInt, contrast=c("treatment","DR","C"))
#same as:
cdr.in <- results(dds.deInt, name = "treatment_DR_vs_C")

mcols(cdr.int) # mcols = metadata columns, i.e. element-wise metadata
(resOrd_cdrint <- cdr.int[order(cdr.int$padj), ])

# Get more info onresults columns
mcols(cdr.int)$description

write.csv(resOrd_cdrint, 
          "../../processed/DESEQ/treatment_DR_vs_C.csv", row.names=TRUE)

resSig_cdr <- subset(resOrd_cdrint, padj < 0.1)
summary(resSig_cdr)
sum(resSig_cdr$padj < 0.1, na.rm = TRUE)

# Log fold change shrinkage for visualization and ranking
# Ref. https://www.biorxiv.org/content/early/2018/04/17/303255 #for fewer NAs in padj??.
library(apeglm)
res_cdr_LFC <- lfcShrink(dds.deInt, coef="treatment_DR_vs_C", type="apeglm") 
res_cdr_LFC

# Compare MA plots
plotMA(cdr.int, ylim=c(-5,5))
plotMA(res_cdr_LFC, ylim=c(-5,5))


#C vs HS
hs.int <- results(dds_deseq, contrast=c("treatment","C","HS"))
(resOrd_hsint <- hs.int[order(hs.int$padj), ])

write.csv(resOrd_hsint, file= 
          "../../processed/DESEQ/treatment_HS_vs_C.csv",
          row.names=TRUE)


```





# Notes
# Note: https://www.biostars.org/p/320132/

```{r}
# Filter step not necessary; default in results() - see ?results, but enhances speed https://support.bioconductor.org/p/65256/
#filter <- rowSums(nc >= 10) >= 5 # at least 10 reads in at least 5 samples

# Increase the maximum iterations (maxit) instead of running DESeq()
#dds <- estimateSizeFactors(ddsDE_filt)
#dds <- estimateDispersions(dds)
#dds <- nbinomWaldTest(dds, maxit=20000)

# To remove the non-converging rows
#ddsClean <- dds[which(mcols(dds)$betaConv),]


## Merge with normalized count data
#res.dds_body <- merge(as.data.frame(res.dds), 
                       #as.data.frame(counts(dds_deseq, normalized=TRUE)), 
                       #by="row.names", sort=FALSE)
#names(res.dds_table)[1] <- "Gene"
#res.dds_body[,1] <- NULL

```